services:
  qdrant:
    image: qdrant/qdrant:latest
    ports: ["6333:6333"]
    volumes: ["./.qdrant:/qdrant/storage"]

  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    command: mlflow server --host 0.0.0.0
      --backend-store-uri sqlite:///mlflow.db
      --artifacts-destination /artifacts
      --serve-artifacts
      --allowed-hosts "mlflow:5000,localhost:*,127.0.0.1:*"
    ports: ["5001:5000"]
    volumes:
      - ./mlflow:/mlflow         
      - ./mlruns:/mlruns
      - ./artifacts:/artifacts

  app:
    build: .
    environment:
      - MODEL_URI=${MODEL_URI}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
      - MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}
      - MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-gdpr_collection}
      - TOKENIZERS_PARALLELISM=${TOKENIZERS_PARALLELISM:-false}
    volumes:
      - ${HOME}/.cache/huggingface:/root/.cache/huggingface
      - ${HOME}/.cache/torch:/root/.cache/torch
    depends_on: [qdrant, mlflow]
    ports: ["8080:8080"]
